name: rest-cli-factory
version: "0.0.1"
author: Vinicius <senna.vmd@gmail.com>
about: Builts CLI binaries for REST APIs
base_endpoint: https://gitlab.com/api/v4
vars:
    done_label: "workflow:Done"
headers:
    Private-Token: "{{env.GITLAB_TOKEN}}"
args:
    - config:
        short: c
        long: config
        value_name: FILE
        help: Sets a custom config file
        takes_value: true
    - verbose:
        short: v
        multiple: true
        help: Sets the level of verbosity
subcommands:
    - show:
        about: show issue data
        path: /projects/{{env.PROJECT_ID}}/issues/{{args.ISSUE_ID}}
        args:
            - ISSUE_ID:
                help: Id of the issue to show
                required: true
                index: 1
            - template:
                short: t
                long: template
                help: Use a different template
                required: false
                takes_value: true
        template: issue.j2
    - project:
        about: show project data
        path: /projects/{{env.PROJECT_ID}}
    - issues:
        about: list issues
        path: /projects/{{env.PROJECT_ID}}/issues
        args:
            - param:
                short: p
                long: param
                help: query params
                long: param
                takes_value: true
                multiple: true
    - newissue:
        about: create an issue
        path: /projects/{{env.PROJECT_ID}}/issues
        method: POST
        args:
            - TITLE:
                help: Issue title
                required: true
                index: 1
            - DESCRIPTION:
                short: d
                long: description
                help: Issue description
                takes_value: true
            - LABELS:
                short: l
                long: labels
                help: labels, comma separated values
                takes_value: true
        body:
            title: "{{ args.TITLE }}"
            description: "{%- if args.DESCRIPTION -%}}args.DESCRIPTION{%- endif -%}"
            labels: "{%- if args.LABELS -%}{{args.LABELS}}{%- endif -%}"
        template: issue.j2
    - edit:
        about: edit an issue
        path: /projects/{{env.PROJECT_ID}}/issues/{{args.ISSUE_ID}}
        method: PUT
        args:
            - ISSUE_ID:
                help: Id of the issue to edit
                required: true
                index: 1
            - labels:
                short: l
                long: labels
                help: labels, comma separated values
                takes_value: true
            - description:
                short: d
                long: description
                help: Issue description
                takes_value: true
            - title:
                short: t
                long: title
                help: Issue title
                takes_value: true
        body:
            description: "{{ args.description }}"
            title: "{{ args.title }}"
            labels: "{{ args.labels }}"
            state_event: "{%- if args.labels is containing(vars.done_label) -%}close{%- else -%}reopen{%- endif -%}"
        template: issue.j2
    - boards:
        about: list boards
        path: /projects/{{env.PROJECT_ID}}/boards
        args:
            - param:
                short: p
                help: query params
                long: param
                takes_value: true
                multiple: true
    - cleanlabels:
        about: Return the issue's list of labels without workflow labels
        args:
            - ISSUE_ID:
                help: Id of the issue
                required: true
                index: 1
        script: |
            LABELS=$(gitlab show {{ args.ISSUE_ID }} | grep Labels: | sed 's/Labels:[ ]\{0,\}//')
            NO_WORKFLOW_LABELS=$(echo $LABELS | sed 's/[ ]\{0,\}workflow:[A-Z a-z]\{1,\}[,]\{0,1\}//g' | sed 's/^[ ]\{1,\}//' | sed 's/[ ]\{0,\}[,]\{0,\}[ ]\{0,\}$//')
            echo $NO_WORKFLOW_LABELS
    - code:
        about: Move issue to code in progress column
        args:
            - ISSUE_ID:
                help: Id of the issue to code
                required: true
                index: 1
        script: |
            LABELS=$(gitlab cleanlabels {{ args.ISSUE_ID }})
            if [ -z "$LABELS" ]; then
                gitlab edit -l "workflow:In progress" {{ args.ISSUE_ID }}
            else
                gitlab edit -l "$LABELS,workflow:In progress" {{ args.ISSUE_ID }}
            fi
            gitlab show {{ args.ISSUE_ID }}
    - done:
        about: Move ticket to done column
        args:
            - ISSUE_ID:
                help: Id of the issue to move
                required: true
                index: 1
        script: |
            LABELS=$(gitlab cleanlabels {{ args.ISSUE_ID }})
            if [ -z "$LABELS" ]; then
                gitlab edit -l "{{ vars.done_label }}" {{ args.ISSUE_ID }}
            else
                gitlab edit -l "$LABELS,{{ vars.done_label }}" {{ args.ISSUE_ID }}
            fi
            gitlab show {{ args.ISSUE_ID }}
